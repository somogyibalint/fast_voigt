#![cfg(test)]
use std::{fmt::{Display, LowerExp}, ops::AddAssign};
use num_traits::{Float, FromPrimitive, AsPrimitive};


const TEST_XAXIS: [f64; 32] = [0.0, 0.01, 0.05, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6,
 0.7, 0.8, 0.9, 1.0, 1.2, 1.4, 1.6, 1.8, 2.0, 2.5, 3.0, 4.0, 5.0, 7.0, 10.0, 
 15.0, 20.0, 30.0, 50.0, 100.0, 200.0, 500.0, 1000.0];

// These reference values were obtained by the `voigt_profile` function of the xsf library, based on Steven G. Johnson's Faddeeva package:
//   XSF library: https://github.com/scipy/xsf
//   SGJ's original implementation: http://ab-initio.mit.edu/faddeeva/
const TEST_DATA: [(f64, [f64; 32]); 13] = [
    (0.000000e+00, [3.98942280401432702863e-01,3.98922333786082161655e-01,3.98443914094764040090e-01,3.96952547477011807864e-01,3.91042693975455879496e-01,3.81387815460524137734e-01,3.68270140303323334496e-01,3.52065326764299524331e-01,3.33224602891799670523e-01,3.12253933366761271540e-01,2.89691552761482784550e-01,2.66085249898754816478e-01,2.41970724519143365328e-01,1.94186054983212952330e-01,1.49727465635744877437e-01,1.10920834679455543315e-01,7.89501583008941493214e-02,5.39909665131880628364e-02,1.75283004935685403358e-02,4.43184841193800752729e-03,1.33830225764885367640e-04,1.48671951473429767790e-06,9.13472040836459364146e-12,7.69459862670641993759e-23,5.53070954984441638358e-50,5.52094836215976353208e-88,1.47364613487854759907e-196,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,0.00000000000000000000e+00,]),
    (1.000000e-06, [3.98942361033788717162e-01,3.98922414390429247444e-01,3.98443994027755321596e-01,3.96952625322616881043e-01,3.91042763630489786930e-01,3.81387872017219631271e-01,3.68270179638592098925e-01,3.52065345769395909858e-01,3.33224599627264417290e-01,3.12253907133658137329e-01,2.89691504087293716374e-01,2.66085180443464408562e-01,2.41970636913307030058e-01,1.94185941751532475941e-01,1.49727343149454822369e-01,1.10920718530863549045e-01,7.89500603998463668098e-02,5.39908936595588570539e-02,1.75282895421908710420e-02,4.43187009402016673237e-03,1.33854187673509500900e-04,1.50139890800227639465e-06,6.95075504523722407401e-09,3.28373438640838478455e-09,1.43400613703312179113e-09,8.01818953240161072700e-10,3.54863175478439799806e-10,1.27477049348281170356e-10,3.18405426738404291799e-11,7.95834405905433807904e-12,1.27325482388472668856e-12,3.18310841116313996335e-13,]),
    (1.000000e-04, [3.98950343258727468942e-01,3.98930393842262087656e-01,3.98451907010084371841e-01,3.96960331637393748494e-01,3.91049659015986872390e-01,3.81393470571528558910e-01,3.68274073155214265451e-01,3.52067226476830918980e-01,3.33224275529619362590e-01,3.12251309062458404231e-01,2.89686684302796204626e-01,2.66078303333303733957e-01,2.41961962956680654013e-01,1.94174731109209297575e-01,1.49715216731652861482e-01,1.10909220031410307716e-01,7.89403688376255768810e-02,5.39836820830824903883e-02,1.75272062944227015324e-02,4.43401703555638352500e-03,1.36226333612060726335e-04,2.95460868743008003940e-06,6.94161221227616386514e-07,3.28371336273617367906e-07,1.43400222816787079801e-07,8.01817741215921721870e-08,3.54862939435100479396e-08,1.27477018975625190972e-08,3.18405407812508797923e-09,7.95834394085622521691e-10,1.27325482085949032723e-10,3.18310840927242393452e-11,]),
    (1.000000e-02, [3.99744719507928281121e-01,3.99724490566157331095e-01,3.99239303772335907272e-01,3.97726897731885242759e-01,3.91734502601042477998e-01,3.81947671280410849803e-01,3.68656603568298157914e-01,3.52247255042324514118e-01,3.33182712299442018722e-01,3.11981504274652932107e-01,2.89194264836070136226e-01,2.65380204963906851656e-01,2.41084779862245801585e-01,1.93046662960009191012e-01,1.48499928460752494974e-01,1.09761612788943072050e-01,7.79777554039808168396e-02,5.32719490689431210417e-02,1.74282455240291865584e-02,4.65279742312983864150e-03,3.72605123144180969998e-04,1.47778661528755785861e-04,6.93163577807968765828e-05,3.28162035852263804926e-05,1.43361282598347678760e-05,8.01696973717595360481e-06,3.54839416413980341284e-06,1.27473991954764016772e-06,3.18403521549979028388e-07,7.95833216047097565725e-08,1.27325451934432481964e-08,3.18310822083104242249e-09,]),
    (1.000000e-01, [4.06554257636969396117e-01,4.06531278309967103457e-01,4.05980175441203960940e-01,4.04262931369114453251e-01,3.97468406828991926982e-01,3.86404419201438031894e-01,3.71445480133617278451e-01,3.53085591702252843405e-01,3.31910876743637839326e-01,3.08568251959142614282e-01,2.83732486407835049480e-01,2.58073979674720954680e-01,2.32229375088987555209e-01,1.82216457972141532284e-01,1.37316995303124911310e-01,9.96586540631355932707e-02,6.99377461163572938796e-02,4.77397271137624257253e-02,1.73488914505852617753e-02,6.95053666162111401239e-03,2.44285594137011018850e-03,1.42314316112105072355e-03,6.84695639593876806232e-04,3.26342618488822521633e-04,1.43020643792209534335e-04,8.00638395738494031443e-05,3.54632940038251059456e-05,1.27447403353175971419e-05,3.18386948262758128381e-06,7.95822864684971617325e-07,1.27325186989280163104e-07,3.18310656496822113034e-08,]),
    (2.500000e-01, [4.15481566448102468403e-01,4.15453107497740337095e-01,4.14770728698136970092e-01,4.12646145350829385290e-01,4.04265545153045802174e-01,3.90707197764062097445e-01,3.72552664249651499517e-01,3.50554865740963172982e-01,3.25584649413921123351e-01,2.98572062163709073257e-01,2.70447914490966279111e-01,2.42090745155975783920e-01,2.14283260936206226832e-01,1.62793745838705816720e-01,1.19457507426397865902e-01,8.55077036182039368351e-02,6.04581616295011559092e-02,4.28400529185483242012e-02,1.99509099368119328932e-02,1.14283850498447889926e-02,5.59514718423863646746e-03,3.41668005019335908196e-03,1.68111927987130973725e-03,8.09070012785418940689e-04,3.56263247078468796476e-04,1.99757408986932135644e-04,8.85795411546319767402e-05,3.18517011960392718429e-05,7.95904063865653754295e-06,1.98951761498775594786e-06,3.18311955220452282907e-07,7.95776008596889606661e-08,]),
    (5.000000e-01, [4.17418561040735436318e-01,4.17378919933802217113e-01,4.16428949619780719438e-01,4.13477741888566063810e-01,4.01932729013334433255e-01,3.83580309100364225117e-01,3.59636651947758456682e-01,3.31591325378333023899e-01,3.01040904675598131046e-01,2.69529105263085599908e-01,2.38415991016977302230e-01,2.08790461012626410442e-01,1.81430398852550883726e-01,1.35116081010220850933e-01,1.00316739566020357577e-01,7.53984622503055812448e-02,5.79182139946216867354e-02,4.56272705174142131912e-02,2.77698425771425033703e-02,1.87553650344222840041e-02,1.02733663902516460242e-02,6.49746971953819082296e-03,3.28171950826556743652e-03,1.59956736012200695721e-03,7.08932462407281852555e-04,3.98385651419868528755e-04,1.76937151395354833701e-04,6.36747134531975356782e-05,1.59162901435930720416e-05,3.97892331414966967068e-06,6.36621045610945989843e-07,1.59155022669426574441e-07,]),
    (7.500000e-01, [3.87816413260399228680e-01,3.87769661405750365457e-01,3.86650337754754658270e-01,3.83185847671542012538e-01,3.69817769865287415687e-01,3.49161385340200858263e-01,3.23271049953972600122e-01,2.94398091474319278937e-01,2.64619480607030665986e-01,2.35590282641449738632e-01,2.08445834821500530776e-01,1.83827605626074197520e-01,1.61981703201712040618e-01,1.26332421824325968895e-01,9.97948922329018467403e-02,8.01187293643049885938e-02,6.53932123015425886825e-02,5.42068631606201015161e-02,3.59335010507440821836e-02,2.54294602752723440664e-02,1.45725554748427250928e-02,9.40643512809941073627e-03,4.83485259151561919816e-03,2.37837735325148805221e-03,1.05926505991365041935e-03,5.96271595224941598073e-04,2.65147721907481900665e-04,9.54786422685545394613e-05,2.38723462228254754006e-05,5.96825441312382585124e-06,9.54928226157242414270e-07,2.38732325113193126401e-07,]),
    (9.000000e-01, [3.49463774219289813328e-01,3.49423080109865558107e-01,3.48449136883726251490e-01,3.45438811321876759752e-01,3.33880579750496397917e-01,3.16186978843372101800e-01,2.94256886193180522415e-01,2.70054468157269689232e-01,2.45275144729294042323e-01,2.21180351695341226304e-01,1.98581053483292524486e-01,1.77909613010056671945e-01,1.59322320554793284142e-01,1.28205502913456337311e-01,1.04107359703826840569e-01,8.55252857062005628075e-02,7.11218901442246254074e-02,5.98486995219711659377e-02,4.07245128854554910847e-02,2.92825313441535776959e-02,1.70707054285432272001e-02,1.11119146617993120457e-02,5.75482557150697963261e-03,2.84260766104629239090e-03,1.26884010456175880255e-03,7.14803235791774526503e-04,3.18034244029819055007e-04,1.14555817028559462408e-04,2.86456553863123600961e-05,7.16183278325367683709e-06,1.14591201501557648503e-06,2.86478674112036428399e-07,]),
    (9.900000e-01, [3.21492342255669583118e-01,3.21459560324832915867e-01,3.20674793901960464293e-01,3.18246898167884928466e-01,3.08892016361779653266e-01,2.94465233868229814274e-01,2.76392123807141454339e-01,2.56175912866369426268e-01,2.35152999532942136307e-01,2.14362237452076942468e-01,1.94517663952161579122e-01,1.76046613178725608329e-01,1.59155103042927348334e-01,1.30219725103499023300e-01,1.07188412024603926809e-01,8.90211109409392159497e-02,7.46764893816481978295e-02,6.32800124213866166389e-02,4.35868798583273486802e-02,3.15763389068454691788e-02,1.85588969760775192308e-02,1.21296778384307659543e-02,6.30508201057379535914e-03,3.12069121951209262067e-03,1.39449094522205358816e-03,7.85891924116124160164e-04,3.49760102468208680833e-04,1.26001332478656763491e-04,3.15095914223041824974e-05,7.87797671200732939193e-06,1.26050220912754549044e-06,3.15126478561029121799e-07,]),
    (9.999000e-01, [3.18341717171772342621e-01,3.18309879818229946036e-01,3.17547689190761706080e-01,3.15189194906160152776e-01,3.06095450609992325575e-01,2.92051798787748340125e-01,2.74424945008624909804e-01,2.54663187821683512091e-01,2.34062401082950871656e-01,2.13638108291757639057e-01,1.94095654557515900906e-01,1.75863661634602513884e-01,1.59154943092054496079e-01,1.30452518922005600288e-01,1.07533636020298750680e-01,8.94089712845949347031e-02,7.50691202387998440804e-02,6.36581575181310727052e-02,4.39016325734545367898e-02,3.18284421392878158485e-02,1.87224588245495232597e-02,1.22415578358746508780e-02,6.36558656869412511220e-03,3.15127411397794765513e-03,1.40831122515634623964e-03,7.93711256741193413485e-04,3.53249862211091998025e-04,1.27260328128660959090e-04,3.18246236937039610995e-05,7.95675250085452564651e-06,1.27310712937075887843e-06,3.18277736981097042144e-07,]),
    (9.999990e-01, [3.18310204493676862647e-01,3.18278376592362022279e-01,3.17516411876405391101e-01,3.15158612069812715806e-01,3.06067480777212463927e-01,2.92027662319946312852e-01,2.74405273003494099004e-01,2.54648061735777919701e-01,2.34051497041675160560e-01,2.13630869218454227942e-01,1.94091436619934443186e-01,1.75861834031787594990e-01,1.59154943091895345608e-01,1.30454847862150502547e-01,1.07537088833835128843e-01,8.94128501965402444629e-02,7.50730467028483949843e-02,6.36619390395717910103e-02,4.39047800942797619705e-02,3.18309631535881737419e-02,1.87240944307133123925e-02,1.22426766292030881483e-02,6.36619161212600374183e-03,3.15157994234723350460e-03,1.40844942783540684472e-03,7.93789450028634948307e-04,3.53284759800747642094e-04,1.27272918084146436637e-04,3.18277740163543725288e-05,7.95754025873902329658e-06,1.27323317857308958859e-06,3.18309249565291602593e-07,]),
    (1.000000e+00, [3.18309886183790691216e-01,3.18278058377952921543e-01,3.17516095943930876100e-01,3.15158303152268004510e-01,3.06067198253644867645e-01,2.92027418517239123474e-01,2.74405074296371231934e-01,2.54647908947032541871e-01,2.34051386899846114442e-01,2.13630796096503816628e-01,1.94091394014506507526e-01,1.75861815571155072346e-01,1.59154943091895345608e-01,1.30454871386799453603e-01,1.07537123710740104010e-01,8.94128893774692873331e-02,7.50730863641015794263e-02,6.36619772367581354677e-02,4.39048118874194037708e-02,3.18309886183790677339e-02,1.87241109519876887390e-02,1.22426879301457958160e-02,6.36619772367581424066e-03,3.15158303152268020123e-03,1.40845082382208271025e-03,7.93790239859827151218e-04,3.53285112301654469734e-04,1.27273045255414120856e-04,3.18278058377952880343e-05,7.95754821588936990962e-06,1.27323445179735560242e-06,3.18309567874222824417e-07,]),
];


pub(crate) fn linspace<T>(fr: T, to: T, n: u32) -> Vec<T> where 
T: Float + FromPrimitive + AddAssign {
    let mut x = T::zero();
    let dx = (to - fr) / ( T::from(n - 1).unwrap()  );
    let mut array = Vec::with_capacity(n as usize);
    for _ in 0..n {
        array.push(x);
        x += dx;
    }
    array
}




pub(crate) fn assert_accuracy<T>(approx: fn(&[T], T, T, T, T)->Vec<T>, precision: f64) where 
T: Float + FromPrimitive + AsPrimitive<f64> + AddAssign + Display + LowerExp{
    let max_err = max_error(approx);
    if max_err.error > T::from_f64(precision).unwrap() {
        panic!(" >> Accuracy criteria not satisfied: {:.2e} > {:.2e} at x: {:.2e} œÅ: {:.6e}", 
        max_err.error, precision, 
        max_err.at_x,
        max_err.at_rho);
    }
}

struct ApproxError<T> {
    error: T,
    at_x: T,
    at_rho: T
}

fn max_error<T>(approx: fn(&[T], T, T, T, T)->Vec<T>) -> ApproxError<T> where 
T: Float + FromPrimitive + AsPrimitive<f64> + AddAssign + Sized {
    let zero = T::zero();
    let one = T::one();
    let x0 = zero;
    let intensity = one;
    let x = TEST_XAXIS.map(|z| T::from_f64(z).unwrap());
    
    let mut max_error = ApproxError{error: zero, at_rho: zero, at_x: zero} ;
    for (rho, expected) in TEST_DATA {
        let rho=  T::from_f64(rho).unwrap();
        let y_expected = expected.map(|z| T::from_f64(z).unwrap());
        let gamma = rho;
        let sigma = one-rho;
        
        let y = approx(&x, x0, gamma, sigma, intensity);
        let err = y.iter()
            .zip(y_expected.iter())
            .map(|(&l, &r)| l-r)
            .collect::<Vec<T>>();
        let (at_x, err) = max_at(&x, &err);
        if err > max_error.error {
            max_error = ApproxError{error: err, at_rho: rho, at_x: at_x}
        }
    }
    max_error
}

fn max_at<T>(xarr: &[T], yarr: &[T]) -> (T, T) where 
T: Float {
    let mut at = xarr[0];
    let mut maxvalue = yarr[0];
    for (x, y) in xarr.iter().zip(yarr.iter()) {
        if !y.is_finite() {
            return  (at, maxvalue)
        }
        if *y > maxvalue {
            at = *x;
            maxvalue = *y;
        }
    }
    (at, maxvalue)
} 
